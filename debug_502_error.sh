#!/bin/bash

echo "üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ 502 Bad Gateway –æ—à–∏–±–∫–∏..."
echo "========================================"

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
echo "1. üìä –°—Ç–∞—Ç—É—Å Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
echo "--------------------------------"
docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

echo ""

# 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ backend
echo "2. üìã –õ–æ–≥–∏ backend (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å—Ç—Ä–æ–∫):"
echo "----------------------------------------"
docker logs --tail=30 $(docker ps -q --filter "name=backend") 2>/dev/null || echo "‚ùå Backend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω"

echo ""

# 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø–æ—Ä—Ç—ã
echo "3. üîå –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –ø–æ—Ä—Ç–æ–≤:"
echo "---------------------------------"
echo "Backend health check (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π):"
docker exec $(docker ps -q --filter "name=backend") curl -s http://localhost:8001/health 2>/dev/null || echo "‚ùå Backend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞"

echo ""

# 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API —Å–Ω–∞—Ä—É–∂–∏
echo "4. üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ API:"
echo "----------------------------"
echo "–ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ API:"
curl -s -w "Status: %{http_code}\n" https://aivi-ai.it.com/api/health || echo "‚ùå –í–Ω–µ—à–Ω–∏–π API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

echo ""

# 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è backend
echo "5. üîß –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è backend:"
echo "-----------------------------------"
docker exec $(docker ps -q --filter "name=backend") env | grep -E "(CLERK|DATABASE|FRONTEND)" | sort 2>/dev/null || echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ"

echo ""

# 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö
echo "6. ‚ùå –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö:"
echo "---------------------------"
docker logs $(docker ps -q --filter "name=backend") 2>&1 | grep -i -E "(error|exception|traceback|failed)" | tail -10 || echo "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"

echo ""

# 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞–º—è—Ç—å –∏ —Ä–µ—Å—É—Ä—Å—ã
echo "7. üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:"
echo "-----------------------------"
docker stats --no-stream --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"

echo ""
echo "‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:"
echo "1. –ï—Å–ª–∏ backend –Ω–µ –∑–∞–ø—É—â–µ–Ω - –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ: docker-compose restart backend"
echo "2. –ï—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö - –∏—Å–ø—Ä–∞–≤—å—Ç–µ –∏—Ö"
echo "3. –ï—Å–ª–∏ –Ω–µ—Ö–≤–∞—Ç–∫–∞ –ø–∞–º—è—Ç–∏ - —É–≤–µ–ª–∏—á—å—Ç–µ —Ä–µ—Å—É—Ä—Å—ã"
echo "4. –ï—Å–ª–∏ database –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ" 