#!/bin/bash

echo "üîß –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ Alembic –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
echo "============================================"

# 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –º—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
if [ ! -f .env ]; then
    echo "‚ùå .env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω! –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ."
    exit 1
fi

# 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
echo "1. üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
echo "------------------------------------"
docker exec $(docker ps -q --filter "name=backend") alembic current 2>/dev/null || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é"

# 3. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏
echo ""
echo "2. üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏:"
echo "------------------------"
docker exec $(docker ps -q --filter "name=backend") alembic history 2>/dev/null || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –º–∏–≥—Ä–∞—Ü–∏–π"

# 4. –°–æ–∑–¥–∞–µ–º backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
echo ""
echo "3. üíæ –°–æ–∑–¥–∞–Ω–∏–µ backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
echo "-----------------------------------"
BACKUP_FILE="backup_$(date +%Y%m%d_%H%M%S).sql"
docker exec $(docker ps -q --filter "name=db") pg_dump -U nfac_user nfac_db > $BACKUP_FILE 2>/dev/null && echo "‚úÖ Backup —Å–æ–∑–¥–∞–Ω: $BACKUP_FILE" || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å backup"

# 5. –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
echo ""
echo "4. üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π..."
echo "---------------------------"
echo "–í—ã–ø–æ–ª–Ω—è–µ–º: alembic upgrade head"
docker exec $(docker ps -q --filter "name=backend") alembic upgrade head

if [ $? -eq 0 ]; then
    echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π!"
    echo "üìã –õ–æ–≥–∏ backend:"
    docker logs --tail=20 $(docker ps -q --filter "name=backend")
    exit 1
fi

# 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
echo ""
echo "5. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞..."
echo "---------------------------"
echo "–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:"
docker exec $(docker ps -q --filter "name=backend") alembic current

echo ""
echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–æ–ª–æ–Ω–∫–∏ clerk_id:"
docker exec $(docker ps -q --filter "name=db") psql -U nfac_user -d nfac_db -c "\d users" | grep clerk_id && echo "‚úÖ –ö–æ–ª–æ–Ω–∫–∞ clerk_id –¥–æ–±–∞–≤–ª–µ–Ω–∞!" || echo "‚ùå –ö–æ–ª–æ–Ω–∫–∞ clerk_id –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"

# 7. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º backend –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
echo ""
echo "6. üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ backend..."
echo "--------------------------"
docker-compose restart backend

echo ""
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ backend (10 —Å–µ–∫)..."
sleep 10

# 8. –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
echo ""
echo "7. üß™ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ API..."
echo "------------------------------"
if curl -s https://aivi-ai.it.com/api/health | grep -q "ok"; then
    echo "‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç!"
    echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
else
    echo "‚ùå API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏"
    echo "üìã –õ–æ–≥–∏ backend:"
    docker logs --tail=10 $(docker ps -q --filter "name=backend")
fi

echo ""
echo "üìã –ß—Ç–æ –¥–∞–ª—å—à–µ:"
echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∞–π—Ç: https://aivi-ai.it.com"
echo "2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Clerk"
echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ —Ä–∞–±–æ—Ç–∞–µ—Ç" 